#!/bin/bash

# Claude API Quick Switch Tool
# A concise API provider switching tool designed for developers
# Supports: GLM, Kimi2, MiniMax, etc.

# Version: 2.1.0
# Multi-language Support Enhanced

# Load multi-language system
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/i18n/loader.sh"

# Color definitions
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Configuration paths
CONFIG_DIR="$HOME/.claude/configs"
CLAUDE_CONFIG="$HOME/.claude/settings.json"
BACKUP_DIR="$HOME/.claude/backups"
ACTIVE_MARKER="$HOME/.claude/.active_config"

# å¤‡ç”¨é…ç½®è·¯å¾„ï¼ˆç”¨äºæƒé™é—®é¢˜æ—¶çš„fallbackï¼‰
ALTERNATIVE_CLAUDE_CONFIG="$HOME/.claude-config/settings.json"
ALTERNATIVE_CONFIG_DIR="$HOME/.claude-config/configs"

# ç¡®ä¿ç›®å½•å­˜åœ¨
ensure_dirs() {
    mkdir -p "$CONFIG_DIR" "$BACKUP_DIR"
}

# æ£€æŸ¥é…ç½®æ–‡ä»¶
check_config_file() {
    if [ ! -f "$CLAUDE_CONFIG" ]; then
        echo -e "${RED}$(format_text "messages.errors.config_not_found" "path" "$CLAUDE_CONFIG")${NC}"
        echo -e "${YELLOW}ğŸ’¡ $(get_text "messages.info.create_config_first")${NC}"
        return 1
    fi
}

# éªŒè¯JSONæ ¼å¼
validate_json() {
    local file="$1"
    if command -v python3 >/dev/null 2>&1; then
        python3 -c "import json; json.load(open('$file'))" 2>/dev/null
    elif command -v jq >/dev/null 2>&1; then
        jq empty "$file" 2>/dev/null
    else
        # ç®€å•JSONæ ¼å¼æ£€æŸ¥
        grep -q '^{.*}$' "$file" && grep -q '.*}$' "$file"
    fi
}

# éªŒè¯é…ç½®å®Œæ•´æ€§
validate_config_completeness() {
    local config_file="$1"

    if ! command -v jq >/dev/null 2>&1; then
        echo "âš ï¸ éœ€è¦å®‰è£…jqä»¥è¿›è¡Œå®Œæ•´éªŒè¯"
        return 0
    fi

    local warnings=()
    local errors=()

    # æ£€æŸ¥å¿…è¦å­—æ®µ
    local auth_token=$(jq -r '.env.ANTHROPIC_AUTH_TOKEN // ""' "$config_file")
    local base_url=$(jq -r '.env.ANTHROPIC_BASE_URL // ""' "$config_file")
    local model=$(jq -r '.env.ANTHROPIC_DEFAULT_SONNET_MODEL // ""' "$config_file")
    local provider=$(jq -r '.provider // ""' "$config_file")

    # è¯­è¨€ç•Œé¢é…ç½®ç‰¹æ®Šå¤„ç†ï¼šè·³è¿‡APIå¯†é’¥éªŒè¯
    if [ "$provider" = "language-ui" ]; then
        echo -e "${GREEN}$(get_text "messages.success.language_valid")${NC}"
        echo -e "${CYAN}$(get_text "messages.success.language_info")${NC}"
        return 0
    fi

    # æ£€æŸ¥APIå¯†é’¥ï¼ˆä»…å¯¹APIæä¾›å•†é…ç½®ï¼‰
    if [ -z "$auth_token" ] || [ "$auth_token" = "your-api-key-here" ] || [ "$auth_token" = "sk-your-api-key-here" ]; then
        errors+=("âŒ $(get_text "messages.errors.api_key_placeholder")")
    fi

    # æ£€æŸ¥APIç«¯ç‚¹
    if [ -z "$base_url" ]; then
        errors+=("âŒ APIç«¯ç‚¹æœªé…ç½®")
    elif [[ "$base_url" != "https://api.anthropic.com" ]]; then
        # éªŒè¯ç¬¬ä¸‰æ–¹APIç«¯ç‚¹æ ¼å¼
        if [[ ! "$base_url" =~ ^https://[^/]+/anthropic/?$ ]]; then
            warnings+=("âš ï¸ APIç«¯ç‚¹æ ¼å¼å¯èƒ½ä¸æ­£ç¡®ï¼Œå»ºè®®ä»¥ /anthropic ç»“å°¾")
        fi
    fi

    # æ£€æŸ¥æ¨¡å‹åç§°
    if [ -z "$model" ] || [ "$model" = "unknown" ]; then
        errors+=("âŒ æ¨¡å‹åç§°æœªé…ç½®æˆ–æ— æ•ˆ")
    fi

    # æ˜¾ç¤ºéªŒè¯ç»“æœ
    if [ ${#errors[@]} -gt 0 ]; then
        echo -e "${RED}$(get_text "messages.errors.config_validation_failed")${NC}"
        for error in "${errors[@]}"; do
            echo "  $error"
        done
        return 1
    fi

    if [ ${#warnings[@]} -gt 0 ]; then
        echo -e "${YELLOW}$(get_text "messages.warnings.config_warnings")${NC}"
        for warning in "${warnings[@]}"; do
            echo "  $warning"
        done
    fi

    return 0
}

# éªŒè¯APIè¿æ¥æ€§ï¼ˆå¯é€‰ï¼‰
validate_api_connectivity() {
    local base_url="$1"

    if command -v curl >/dev/null 2>&1; then
        echo "ğŸ” æ£€æŸ¥APIè¿æ¥æ€§..."
        if curl -s --connect-timeout 5 "$base_url" >/dev/null 2>&1; then
            echo "âœ… APIç«¯ç‚¹å¯è¾¾"
            return 0
        else
            echo "âš ï¸ APIç«¯ç‚¹ä¸å¯è¾¾ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥"
            return 1
        fi
    else
        echo "ğŸ“ éœ€è¦å®‰è£…curlä»¥æ£€æŸ¥APIè¿æ¥æ€§"
        return 0
    fi
}

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
show_help() {
    echo -e "${BLUE}$(get_text "app.title")${NC}"
    echo ""
    echo "$(get_text "help.title")"

    # æ˜¾ç¤ºç”¨æ³•ä¿¡æ¯ - ç®€åŒ–å¤„ç†ï¼Œç›´æ¥è¯»å–JSONæ•°ç»„
    if command -v jq >/dev/null 2>&1; then
        local resource_file="$I18N_DIR/$CURRENT_LANGUAGE.json"
        if [ -f "$resource_file" ]; then
            echo ""
            # ç”¨æ³•ä¿¡æ¯
            local usage_items=$(jq -r '.help.usage[]' "$resource_file" 2>/dev/null)
            while IFS= read -r line; do
                if [ -n "$line" ]; then
                    echo "  $(format_text_line "$line" "0" "$0")"
                fi
            done <<< "$usage_items"

            echo ""
            echo "$(get_text "help.aliases_title")"
            # åˆ«åä¿¡æ¯
            local alias_items=$(jq -r '.help.aliases[]' "$resource_file" 2>/dev/null)
            while IFS= read -r line; do
                if [ -n "$line" ]; then
                    echo "  $line"
                fi
            done <<< "$alias_items"

            echo ""
            echo "$(get_text "help.providers_title")"
            # ä¾›åº”å•†ä¿¡æ¯
            local provider_items=$(jq -r '.help.providers[]' "$resource_file" 2>/dev/null)
            while IFS= read -r line; do
                if [ -n "$line" ]; then
                    echo "  $line"
                fi
            done <<< "$provider_items"

            echo ""
            echo "$(get_text "help.examples_title")"
            # ç¤ºä¾‹ä¿¡æ¯
            local example_items=$(jq -r '.help.examples[]' "$resource_file" 2>/dev/null)
            while IFS= read -r line; do
                if [ -n "$line" ]; then
                    echo "  $(format_text_line "$line" "0" "$0")"
                fi
            done <<< "$example_items"
        fi
    fi
}

# åˆ‡æ¢è¯­è¨€
switch_language_to() {
    local target_lang="$1"

    # éªŒè¯è¯­è¨€èµ„æºæ˜¯å¦å­˜åœ¨
    local resource_file="$I18N_DIR/$target_lang.json"
    if [ ! -f "$resource_file" ]; then
        echo -e "${RED}âŒ $(format_text "messages.errors.config_not_found" "path" "$resource_file")${NC}"
        return 1
    fi

    # åˆ‡æ¢è¯­è¨€
    if set_language "$target_lang"; then
        echo -e "${GREEN}$(get_text "messages.success.language_valid")${NC}"
        echo -e "${CYAN}$(get_text "messages.success.language_info")${NC}"

        # å¯é€‰ï¼šè®¾ç½®ç¯å¢ƒå˜é‡ä»¥ä¾¿åç»­ä¼šè¯è®°ä½è¯­è¨€é€‰æ‹©
        export CLAUDE_LANG="$target_lang"

        # æ˜¾ç¤ºå½“å‰è¯­è¨€çš„å¸®åŠ©ä¿¡æ¯
        echo ""
        show_help
    else
        echo -e "${RED}âŒ $(format_text "messages.errors.config_not_found" "path" "$resource_file")${NC}"
        return 1
    fi
}

# è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ–‡æœ¬è¡Œï¼ˆæ”¯æŒç®€å•çš„$0æ›¿æ¢ï¼‰
format_text_line() {
    local line="$1"
    local param_name="$2"
    local param_value="$3"

    if [ -n "$param_value" ]; then
        line="${line//\$$param_name/$param_value}"
    fi

    echo "$line"
}

# è·å–å½“å‰é…ç½®ä¿¡æ¯
get_current_config() {
    if [ -f "$ACTIVE_MARKER" ]; then
        cat "$ACTIVE_MARKER"
    else
        echo "default"
    fi
}

# æ˜¾ç¤ºé…ç½®çŠ¶æ€
show_status() {
    echo -e "${BLUE}å½“å‰é…ç½®çŠ¶æ€:${NC}"
    echo "=================="

    # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼ŒåŒ…æ‹¬å¤‡ç”¨è·¯å¾„
    local actual_config="$CLAUDE_CONFIG"
    if [ ! -f "$CLAUDE_CONFIG" ] && [ -f "$ALTERNATIVE_CLAUDE_CONFIG" ]; then
        actual_config="$ALTERNATIVE_CLAUDE_CONFIG"
        echo -e "${YELLOW}â„¹ï¸  ä½¿ç”¨å¤‡ç”¨é…ç½®è·¯å¾„: $ALTERNATIVE_CLAUDE_CONFIG${NC}"
    fi

    if [ ! -f "$actual_config" ]; then
        echo -e "${RED}âŒ Claudeé…ç½®æ–‡ä»¶ä¸å­˜åœ¨${NC}"
        echo -e "${RED}   ä¸»è·¯å¾„: $CLAUDE_CONFIG${NC}"
        echo -e "${RED}   å¤‡ç”¨è·¯å¾„: $ALTERNATIVE_CLAUDE_CONFIG${NC}"
        return 1
    fi

    local current=$(get_current_config)
    echo -e "${GREEN}å½“å‰é…ç½®: $current${NC}"

    if command -v jq >/dev/null 2>&1; then
        echo ""
        echo "APIé…ç½®:"
        jq -r '.env | to_entries[] | "  \(.key): \(.value)"' "$actual_config" 2>/dev/null || echo "  é…ç½®è§£æå¤±è´¥"
    else
        echo ""
        echo "é…ç½®æ–‡ä»¶: $CLAUDE_CONFIG"
    fi
}

# åˆ—å‡ºæ‰€æœ‰é…ç½®
list_configs() {
    echo -e "${BLUE}å¯ç”¨çš„APIé…ç½®:${NC}"
    echo "=================="

    local current=$(get_current_config)

    # æ˜¾ç¤ºå½“å‰é…ç½®
    if [ -f "$CLAUDE_CONFIG" ]; then
        echo -e "${GREEN}* å½“å‰é…ç½®: $current${NC}"
        if command -v jq >/dev/null 2>&1; then
            local base_url=$(jq -r '.env.ANTHROPIC_BASE_URL // "æœªçŸ¥"' "$CLAUDE_CONFIG")
            local model=$(jq -r '.env.ANTHROPIC_DEFAULT_SONNET_MODEL // "æœªçŸ¥"' "$CLAUDE_CONFIG")
            echo "  BASE_URL: $base_url"
            echo "  MODEL: $model"
        fi
        echo ""
    fi

    # æ˜¾ç¤ºå¯ç”¨é…ç½®
    if [ "$(ls -A "$CONFIG_DIR" 2>/dev/null)" ]; then
        echo -e "${YELLOW}å¯ç”¨é…ç½®:${NC}"
        local i=1
        for config in "$CONFIG_DIR"/*.json; do
            if [ -f "$config" ]; then
                local name=$(basename "$config" .json)

                # æ’é™¤ç‰¹æ®Šé…ç½®ç±»å‹ï¼ˆä¸åˆ«åç”Ÿæˆé€»è¾‘ä¿æŒä¸€è‡´ï¼‰
                case "$name" in
                    zh-ui|en-ui|test-*|*.tmp|*.backup*)
                        continue
                        ;;
                esac
                local marker=" "
                if [ "$name" = "$current" ]; then
                    marker="*"
                    echo -e "${GREEN}$marker $i. $name (å½“å‰)${NC}"
                else
                    echo "  $i. $name"
                fi

                if command -v jq >/dev/null 2>&1; then
                    local base_url=$(jq -r '.env.ANTHROPIC_BASE_URL // "æœªçŸ¥"' "$config")
                    local model=$(jq -r '.env.ANTHROPIC_DEFAULT_SONNET_MODEL // "æœªçŸ¥"' "$config")
                    echo "     BASE_URL: $base_url"
                    echo "     MODEL: $model"
                fi
                echo ""
                ((i++))
            fi
        done
    else
        echo -e "${YELLOW}æ²¡æœ‰æ‰¾åˆ°é…ç½®æ–‡ä»¶${NC}"
        echo "é…ç½®ç›®å½•: $CONFIG_DIR"
    fi
}

# å¤‡ä»½å½“å‰é…ç½®
backup_config() {
    if [ ! -f "$CLAUDE_CONFIG" ]; then
        echo -e "${RED}âŒ æ²¡æœ‰å¯å¤‡ä»½çš„é…ç½®æ–‡ä»¶${NC}"
        return 1
    fi

    local backup_file="$BACKUP_DIR/settings.backup.$(date +%Y%m%d_%H%M%S).json"
    if cp "$CLAUDE_CONFIG" "$backup_file"; then
        echo -e "${GREEN}âœ… é…ç½®å·²å¤‡ä»½åˆ°: $backup_file${NC}"
    else
        echo -e "${RED}âŒ å¤‡ä»½å¤±è´¥: æ— æ³•å†™å…¥ $backup_file${NC}"
        return 1
    fi
}

# åˆ‡æ¢é…ç½®
switch_config() {
    local target="$1"

    if [ -z "$target" ]; then
        echo -e "${RED}$(get_text "messages.errors.no_config_specified")${NC}"
        echo "$(format_text "messages.errors.usage_switch" "0" "$0")"
        echo "$(format_text "messages.errors.use_list" "0" "$0")"
        return 1
    fi

    ensure_dirs
    check_config_file || return 1

    # å¤„ç†æ•°å­—ç¼–å·
    if [[ "$target" =~ ^[0-9]+$ ]]; then
        local configs=("$CONFIG_DIR"/*.json)
        local index=$((target - 1))
        if [ $index -ge 0 ] && [ $index -lt ${#configs[@]} ] && [ -f "${configs[$index]}" ]; then
            target=$(basename "${configs[$index]}" .json)
        else
            echo -e "${RED}$(format_text "messages.errors.config_number_invalid" "number" "$target")${NC}"
            echo "$(format_text "messages.errors.use_list" "0" "$0")"
            return 1
        fi
    fi

    # æŸ¥æ‰¾é…ç½®æ–‡ä»¶
    local config_file="$CONFIG_DIR/$target.json"

    if [ ! -f "$config_file" ]; then
        echo -e "${RED}$(format_text "messages.errors.config_name_invalid" "name" "$target")${NC}"
        echo "$(format_text "messages.errors.use_list" "0" "$0")"
        return 1
    fi

    # éªŒè¯é…ç½®æ–‡ä»¶æ ¼å¼
    if ! validate_json "$config_file"; then
        echo -e "${RED}$(format_text "messages.errors.config_format_invalid" "path" "$config_file")${NC}"
        return 1
    fi

    # éªŒè¯é…ç½®å®Œæ•´æ€§
    if ! validate_config_completeness "$config_file"; then
        echo -e "${RED}$(get_text "messages.errors.config_validation_failed")${NC}"
        return 1
    fi

    # å¯é€‰ï¼šéªŒè¯APIè¿æ¥æ€§
    if [ "${VALIDATE_API:-false}" = "true" ]; then
        local base_url=$(jq -r '.env.ANTHROPIC_BASE_URL // ""' "$config_file")
        validate_api_connectivity "$base_url"
    fi

    # åˆ‡æ¢é…ç½®å¹¶åº”ç”¨ç¯å¢ƒå˜é‡è¦†ç›–
    apply_config_with_env_overrides "$config_file" "$target"

    if ! printf '%s' "$target" > "$ACTIVE_MARKER"; then
        echo -e "${YELLOW}âš ï¸ æ— æ³•æ›´æ–°æ´»åŠ¨é…ç½®æ ‡è®° ($ACTIVE_MARKER)ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥æƒé™${NC}"
    fi

    echo -e "${GREEN}âœ… å·²åˆ‡æ¢åˆ°é…ç½®: $target${NC}"

    # æ˜¾ç¤ºæ–°é…ç½®ä¿¡æ¯
    show_config_info "$config_file"

    echo ""
    echo -e "${CYAN}ğŸ’¡ é‡å¯Claude CLIä»¥åº”ç”¨æ–°é…ç½®${NC}"
}

# åº”ç”¨é…ç½®å¹¶å¤„ç†ç¯å¢ƒå˜é‡è¦†ç›–
apply_config_with_env_overrides() {
    local config_file="$1"
    local config_name="$2"
    local temp_config=$(mktemp)

    # è¯»å–åŸºç¡€é…ç½®
    if command -v jq >/dev/null 2>&1; then
        # ä½¿ç”¨jqå¤„ç†ç¯å¢ƒå˜é‡è¦†ç›–
        jq '
            .env |= with_entries(
                if .key == "ANTHROPIC_AUTH_TOKEN" and ($ENV_ANTHROPIC_AUTH_TOKEN | length) > 0 then
                    .value = $ENV_ANTHROPIC_AUTH_TOKEN
                elif .key == "ANTHROPIC_BASE_URL" and ($ENV_ANTHROPIC_BASE_URL | length) > 0 then
                    .value = $ENV_ANTHROPIC_BASE_URL
                elif .key == "ANTHROPIC_DEFAULT_OPUS_MODEL" and ($ENV_ANTHROPIC_DEFAULT_OPUS_MODEL | length) > 0 then
                    .value = $ENV_ANTHROPIC_DEFAULT_OPUS_MODEL
                elif .key == "ANTHROPIC_DEFAULT_SONNET_MODEL" and ($ENV_ANTHROPIC_DEFAULT_SONNET_MODEL | length) > 0 then
                    .value = $ENV_ANTHROPIC_DEFAULT_SONNET_MODEL
                elif .key == "ANTHROPIC_DEFAULT_HAIKU_MODEL" and ($ENV_ANTHROPIC_DEFAULT_HAIKU_MODEL | length) > 0 then
                    .value = $ENV_ANTHROPIC_DEFAULT_HAIKU_MODEL
                else
                    .
                end
            )
        ' --arg ENV_ANTHROPIC_AUTH_TOKEN "${ANTHROPIC_AUTH_TOKEN:-}" \
           --arg ENV_ANTHROPIC_BASE_URL "${ANTHROPIC_BASE_URL:-}" \
           --arg ENV_ANTHROPIC_DEFAULT_OPUS_MODEL "${ANTHROPIC_DEFAULT_OPUS_MODEL:-}" \
           --arg ENV_ANTHROPIC_DEFAULT_SONNET_MODEL "${ANTHROPIC_DEFAULT_SONNET_MODEL:-}" \
           --arg ENV_ANTHROPIC_DEFAULT_HAIKU_MODEL "${ANTHROPIC_DEFAULT_HAIKU_MODEL:-}" \
           "$config_file" > "$temp_config"

        # æ£€æŸ¥æ˜¯å¦æœ‰ç¯å¢ƒå˜é‡è¦†ç›–
        local overrides_active=false
        [ -n "${ANTHROPIC_AUTH_TOKEN:-}" ] && overrides_active=true
        [ -n "${ANTHROPIC_BASE_URL:-}" ] && overrides_active=true
        [ -n "${ANTHROPIC_DEFAULT_SONNET_MODEL:-}" ] && overrides_active=true

        if [ "$overrides_active" = true ]; then
            echo -e "${YELLOW}ğŸ”§ æ£€æµ‹åˆ°ç¯å¢ƒå˜é‡è¦†ç›–ï¼Œæ­£åœ¨åº”ç”¨...${NC}"
        fi
    else
        # æ— jqæ—¶ç®€å•å¤åˆ¶
        cp "$config_file" "$temp_config"
    fi

    # åº”ç”¨é…ç½®åˆ°Claude settings.json
    if ! cp "$temp_config" "$CLAUDE_CONFIG" 2>/dev/null; then
        echo -e "${YELLOW}âš ï¸  ä¸»é…ç½®è·¯å¾„å†™å…¥å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨è·¯å¾„${NC}"

        # å°è¯•ä½¿ç”¨å¤‡ç”¨é…ç½®è·¯å¾„
        mkdir -p "$(dirname "$ALTERNATIVE_CLAUDE_CONFIG")"
        if ! cp "$temp_config" "$ALTERNATIVE_CLAUDE_CONFIG"; then
            echo -e "${RED}âŒ åˆ‡æ¢å¤±è´¥: æ— æ³•å†™å…¥é…ç½®æ–‡ä»¶${NC}"
            echo -e "${RED}   ä¸»è·¯å¾„: $CLAUDE_CONFIG${NC}"
            echo -e "${RED}   å¤‡ç”¨è·¯å¾„: $ALTERNATIVE_CLAUDE_CONFIG${NC}"
            echo ""
            echo -e "${CYAN}ğŸ’¡ å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ:${NC}"
            echo "   1. æ£€æŸ¥ ~/.claude/ ç›®å½•æƒé™: chmod 755 ~/.claude"
            echo "   2. è¿è¡Œæƒé™è¯Šæ–­è„šæœ¬: ./diagnose_permissions.sh"
            echo "   3. å°è¯•æ‰‹åŠ¨è®¾ç½®ç¯å¢ƒå˜é‡:"
            echo "      export ANTHROPIC_AUTH_TOKEN='your-api-key'"
            echo "      export ANTHROPIC_BASE_URL='your-base-url'"
            echo ""
            rm -f "$temp_config"
            return 1
        else
            echo -e "${GREEN}âœ… å·²ä½¿ç”¨å¤‡ç”¨é…ç½®è·¯å¾„: $ALTERNATIVE_CLAUDE_CONFIG${NC}"
            echo -e "${YELLOW}âš ï¸  è¯·è®¾ç½®ç¯å¢ƒå˜é‡ CLAUDE_CONFIG_DIR=$HOME/.claude-config${NC}"
            CLAUDE_CONFIG="$ALTERNATIVE_CLAUDE_CONFIG"
        fi
    fi

    rm -f "$temp_config"
}

# æ˜¾ç¤ºé…ç½®ä¿¡æ¯ï¼ˆåŒ…å«è¦†ç›–çŠ¶æ€ï¼‰
show_config_info() {
    local config_file="$1"

    if ! command -v jq >/dev/null 2>&1; then
        echo "  (éœ€è¦å®‰è£…jqä»¥æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯)"
        return
    fi

    # æ£€æŸ¥å®é™…åº”ç”¨çš„é…ç½®ï¼ˆä»settings.jsonï¼‰
    local base_url=$(jq -r '.env.ANTHROPIC_BASE_URL // "æœªçŸ¥"' "$CLAUDE_CONFIG")
    local model=$(jq -r '.env.ANTHROPIC_DEFAULT_SONNET_MODEL // "æœªçŸ¥"' "$CLAUDE_CONFIG")

    echo "  BASE_URL: $base_url"
    echo "  MODEL: $model"

    # æ£€æŸ¥ç¯å¢ƒå˜é‡è¦†ç›–
    local overrides=()
    local env_token="${ANTHROPIC_AUTH_TOKEN:-}"
    local env_base_url="${ANTHROPIC_BASE_URL:-}"
    local env_sonnet="${ANTHROPIC_DEFAULT_SONNET_MODEL:-}"
    local env_haiku="${ANTHROPIC_DEFAULT_HAIKU_MODEL:-}"

    # è·å–åŸå§‹é…ç½®å€¼
    local orig_token=$(jq -r '.env.ANTHROPIC_AUTH_TOKEN // ""' "$config_file")
    local orig_base_url=$(jq -r '.env.ANTHROPIC_BASE_URL // ""' "$config_file")
    local orig_sonnet=$(jq -r '.env.ANTHROPIC_DEFAULT_SONNET_MODEL // ""' "$config_file")
    local orig_haiku=$(jq -r '.env.ANTHROPIC_DEFAULT_HAIKU_MODEL // ""' "$config_file")

    # æ£€æŸ¥å“ªäº›ç¯å¢ƒå˜é‡è¢«è¦†ç›–äº†
    [ -n "$env_token" ] && [ "$env_token" != "$orig_token" ] && overrides+=("AUTH_TOKEN")
    [ -n "$env_base_url" ] && [ "$env_base_url" != "$orig_base_url" ] && overrides+=("BASE_URL")
    [ -n "$env_sonnet" ] && [ "$env_sonnet" != "$orig_sonnet" ] && overrides+=("SONNET_MODEL")
    [ -n "$env_haiku" ] && [ "$env_haiku" != "$orig_haiku" ] && overrides+=("HAIKU_MODEL")

    if [ ${#overrides[@]} -gt 0 ]; then
        echo -e "  ${YELLOW}ğŸ”§ ç¯å¢ƒå˜é‡è¦†ç›–: ${overrides[*]}${NC}"
    fi

    # æ˜¾ç¤ºæ¨¡å‹ä¿¡æ¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if jq -e '.models' "$config_file" >/dev/null 2>&1; then
        local model_count=$(jq -r '.models | keys | length' "$config_file")
        if [ "$model_count" -gt 1 ]; then
            echo "  å¯ç”¨æ¨¡å‹: $model_count ä¸ª"
        fi
    fi
}

# ä¿å­˜å½“å‰é…ç½®
save_config() {
    local name="$1"

    if [ -z "$name" ]; then
        echo -e "${RED}âŒ è¯·æä¾›é…ç½®åç§°${NC}"
        echo "ç”¨æ³•: $0 save <é…ç½®åç§°>"
        return 1
    fi

    # æ£€æŸ¥åç§°æ˜¯å¦æœ‰æ•ˆ
    if [[ ! "$name" =~ ^[a-zA-Z0-9_-]+$ ]]; then
        echo -e "${RED}âŒ é…ç½®åç§°åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œè¿å­—ç¬¦${NC}"
        return 1
    fi

    # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨
    local config_file="$CONFIG_DIR/$name.json"
    if [ -f "$config_file" ]; then
        echo -e "${YELLOW}âš ï¸ é…ç½® '$name' å·²å­˜åœ¨${NC}"
        if ! read -t 30 -p "æ˜¯å¦è¦†ç›–? (y/N): " -r 2>/dev/null; then
            echo -e "${RED}âŒ è¾“å…¥è¶…æ—¶ï¼Œæ“ä½œå–æ¶ˆ${NC}"
            return 1
        fi
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "æ“ä½œå·²å–æ¶ˆ"
            return 0
        fi
    fi

    # æ£€æŸ¥å½“å‰é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if [ ! -f "$CLAUDE_CONFIG" ]; then
        echo -e "${RED}âŒ å½“å‰Claudeé…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $CLAUDE_CONFIG${NC}"
        return 1
    fi

    # éªŒè¯å½“å‰é…ç½®æ–‡ä»¶æ ¼å¼
    if ! validate_json "$CLAUDE_CONFIG"; then
        echo -e "${RED}âŒ å½“å‰é…ç½®æ–‡ä»¶æ ¼å¼æ— æ•ˆï¼Œæ— æ³•ä¿å­˜${NC}"
        return 1
    fi

    # åˆ›å»ºæ ‡å‡†åŒ–çš„é…ç½®æ–‡ä»¶ç»“æ„
    local temp_file=$(mktemp)
    if command -v jq >/dev/null 2>&1; then
        # ä½¿ç”¨jqåˆ›å»ºæ ‡å‡†ç»“æ„
        local current_time=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

        jq --arg name "$name" \
           --arg display_name "é…ç½®: $name" \
           --arg description "ç”¨æˆ·è‡ªå®šä¹‰é…ç½®" \
           --arg created_time "$current_time" \
           --arg updated_time "$current_time" \
           --arg version "2.0" '
            {
                name: $name,
                display_name: $display_name,
                provider: (.provider // "custom"),
                description: $description,
                env: .env,
                models: (
                    if .models then
                        .models
                    else
                        {
                            (.default_model // "default"): "é»˜è®¤æ¨¡å‹"
                        }
                    end
                ),
                default_model: (.default_model // "default"),
                metadata: {
                    created_at: $created_time,
                    updated_at: $updated_time,
                    version: $version,
                    author: "user",
                    source: "claude-switch-save"
                }
            }
        ' "$CLAUDE_CONFIG" > "$temp_file"
    else
        # ç®€å•å¤åˆ¶ï¼ˆæ— jqæ—¶ï¼‰- æ·»åŠ åŸºæœ¬ç»“æ„æ³¨é‡Š
        cp "$CLAUDE_CONFIG" "$temp_file"
        echo ""
        echo "# æ³¨æ„ï¼šå»ºè®®å®‰è£… jq å·¥å…·ä»¥è·å¾—æ›´å¥½çš„é…ç½®æ–‡ä»¶æ ¼å¼æ”¯æŒ" >> "$temp_file"
    fi

    # ä¿å­˜é…ç½®æ–‡ä»¶
    if mv "$temp_file" "$config_file"; then
        echo -e "${GREEN}âœ… é…ç½®å·²ä¿å­˜: $name${NC}"
        echo "  ä½ç½®: $config_file"

        # æ˜¾ç¤ºä¿å­˜çš„é…ç½®ä¿¡æ¯
        if command -v jq >/dev/null 2>&1; then
            local base_url=$(jq -r '.env.ANTHROPIC_BASE_URL // "æœªçŸ¥"' "$config_file")
            local model=$(jq -r '.default_model // "æœªçŸ¥"' "$config_file")
            echo "  BASE_URL: $base_url"
            echo "  é»˜è®¤æ¨¡å‹: $model"
        fi
    else
        echo -e "${RED}âŒ ä¿å­˜é…ç½®å¤±è´¥${NC}"
        rm -f "$temp_file"
        return 1
    fi
}

# åˆ é™¤é…ç½®
delete_config() {
    local name="$1"

    if [ -z "$name" ]; then
        echo -e "${RED}âŒ è¯·æä¾›è¦åˆ é™¤çš„é…ç½®åç§°${NC}"
        echo "ç”¨æ³•: $0 delete <é…ç½®åç§°>"
        echo "ä½¿ç”¨ '$0 list' æŸ¥çœ‹å¯ç”¨é…ç½®"
        return 1
    fi

    # æ£€æŸ¥æ˜¯å¦ä¸ºå½“å‰æ´»åŠ¨é…ç½®
    if [ -f "$ACTIVE_MARKER" ] && [ "$(cat "$ACTIVE_MARKER")" = "$name" ]; then
        echo -e "${RED}âŒ æ— æ³•åˆ é™¤å½“å‰æ´»åŠ¨é…ç½® '$name'${NC}"
        echo "è¯·å…ˆåˆ‡æ¢åˆ°å…¶ä»–é…ç½®å†åˆ é™¤æ­¤é…ç½®"
        return 1
    fi

    local config_file="$CONFIG_DIR/$name.json"

    if [ ! -f "$config_file" ]; then
        echo -e "${RED}âŒ é…ç½® '$name' ä¸å­˜åœ¨${NC}"
        echo "ä½¿ç”¨ '$0 list' æŸ¥çœ‹å¯ç”¨é…ç½®"
        return 1
    fi

    # ç¡®è®¤åˆ é™¤æ“ä½œ
    echo -e "${YELLOW}âš ï¸ å³å°†åˆ é™¤é…ç½®: $name${NC}"
    echo "  æ–‡ä»¶: $config_file"
    if ! read -t 30 -p "ç¡®è®¤åˆ é™¤? (è¾“å…¥ 'yes' ç¡®è®¤): " -r 2>/dev/null; then
        echo -e "${RED}âŒ è¾“å…¥è¶…æ—¶ï¼Œæ“ä½œå–æ¶ˆ${NC}"
        return 1
    fi
    if [[ "$REPLY" != "yes" ]]; then
        echo "æ“ä½œå·²å–æ¶ˆ"
        return 0
    fi

    # åˆ›å»ºå¤‡ä»½ï¼ˆå¯é€‰ï¼‰
    local backup_file="$BACKUP_DIR/${name}_deleted_$(date +%Y%m%d_%H%M%S).json"
    if cp "$config_file" "$backup_file"; then
        echo -e "${BLUE}ğŸ“¦ å·²åˆ›å»ºå¤‡ä»½: $backup_file${NC}"
    fi

    # åˆ é™¤é…ç½®æ–‡ä»¶
    if rm "$config_file"; then
        echo -e "${GREEN}âœ… é…ç½® '$name' å·²åˆ é™¤${NC}"
    else
        echo -e "${RED}âŒ åˆ é™¤é…ç½®å¤±è´¥${NC}"
        return 1
    fi
}

# äº¤äº’å¼åˆ›å»ºæ–°é…ç½®
create_config_interactive() {
    echo -e "${BLUE}ğŸ”§ äº¤äº’å¼é…ç½®åˆ›å»ºå‘å¯¼${NC}"
    echo "========================"
    echo ""

    # æ­¥éª¤1ï¼šé€‰æ‹©é…ç½®åç§°
    while true; do
        # æ·»åŠ è¶…æ—¶å’Œè¾“å…¥æ£€æŸ¥
        if [ -t 0 ]; then
            # äº¤äº’å¼è¾“å…¥
            if ! read -t 60 -p "è¯·è¾“å…¥é…ç½®åç§° (åªå…è®¸å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œè¿å­—ç¬¦): " config_name 2>/dev/null; then
                echo -e "${RED}âŒ è¾“å…¥è¶…æ—¶æˆ–æ— æ³•è¯»å–è¾“å…¥ï¼Œæ­£åœ¨é€€å‡º...${NC}"
                return 1
            fi
        else
            # ç®¡é“è¾“å…¥
            read -r config_name
        fi

        # æ£€æŸ¥æ˜¯å¦ä¸ºç©º
        if [ -z "$config_name" ]; then
            echo -e "${RED}âŒ é…ç½®åç§°ä¸èƒ½ä¸ºç©º${NC}"
            continue
        fi
        # æ£€æŸ¥æ ¼å¼
        if [[ "$config_name" =~ ^[a-zA-Z0-9_-]+$ ]]; then
            local config_file="$CONFIG_DIR/$config_name.json"
            if [ -f "$config_file" ]; then
                echo -e "${YELLOW}âš ï¸ é…ç½® '$config_name' å·²å­˜åœ¨${NC}"
                if ! read -t 30 -p "æ˜¯å¦è¦†ç›–? (y/N): " -r 2>/dev/null; then
                    echo -e "${RED}âŒ è¾“å…¥è¶…æ—¶ï¼Œæ“ä½œå–æ¶ˆ${NC}"
                    return 1
                fi
                if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                    echo "æ“ä½œå·²å–æ¶ˆ"
                    return 0
                fi
            fi
            break
        else
            echo -e "${RED}âŒ é…ç½®åç§°æ ¼å¼æ— æ•ˆï¼Œåªå…è®¸å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œè¿å­—ç¬¦${NC}"
        fi
    done

    # æ­¥éª¤2ï¼šé€‰æ‹©é…ç½®æ–¹å¼
    echo ""
    echo "è¯·é€‰æ‹©é…ç½®æ–¹å¼:"
    echo "  1. åŸºäºç°æœ‰æä¾›å•†æ¨¡æ¿"
    echo "  2. åŸºäºå½“å‰Claudeé…ç½®"
    echo "  3. å®Œå…¨è‡ªå®šä¹‰é…ç½®"
    echo ""
    if [ -t 0 ]; then
        # äº¤äº’å¼è¾“å…¥
        if ! read -t 30 -p "è¯·é€‰æ‹© (1-3): " -n 1 -r 2>/dev/null; then
            echo -e "${RED}âŒ è¾“å…¥è¶…æ—¶ï¼Œæ“ä½œå–æ¶ˆ${NC}"
            return 1
        fi
    else
        # ç®¡é“è¾“å…¥
        read -r REPLY
    fi
    echo ""

    case $REPLY in
        1)
            create_from_template "$config_name"
            ;;
        2)
            create_from_current "$config_name"
            ;;
        3)
            create_custom "$config_name"
            ;;
        *)
            echo -e "${RED}âŒ æ— æ•ˆé€‰æ‹©${NC}"
            return 1
            ;;
    esac
}

# åŸºäºæ¨¡æ¿åˆ›å»ºé…ç½®
create_from_template() {
    local config_name="$1"

    echo ""
    echo -e "${BLUE}ğŸ“‹ å¯ç”¨çš„æä¾›å•†æ¨¡æ¿:${NC}"
    echo "===================="

    local all_templates=(
        "anthropic-official:Claudeå®˜æ–¹"
        "glm:æ™ºè°±AI"
        "kimi2:æœˆä¹‹æš—é¢"
        "kimi-cn:Kimiä¸­å›½ç‰ˆ"
        "kimi-global:Kimiå›½é™…ç‰ˆ"
        "minimax:MiniMax"
        "deepseek:DeepSeek"
        "qwen:é€šä¹‰åƒé—®"
        "hunyuan:è…¾è®¯æ··å…ƒ"
        "doubao:è±†åŒ…"
        "ernie:æ–‡å¿ƒä¸€è¨€"
        "sensenova:å•†æ±¤SenseNova"
        "zh-ui:ä¸­æ–‡ç•Œé¢"
        "en-ui:è‹±æ–‡ç•Œé¢"
    )

    # è¿‡æ»¤å‡ºå®é™…å­˜åœ¨çš„æ¨¡æ¿æ–‡ä»¶
    local templates=()
    local template_indices=()

    for i in "${!all_templates[@]}"; do
        local key="${all_templates[$i]%%:*}"
        local name="${all_templates[$i]##*:}"
        local template_file="$CONFIG_DIR/$key.json"

        if [ -f "$template_file" ]; then
            templates+=("$key:$name")
            template_indices+=($i)

            # ä¸ºè¯­è¨€æ¨¡æ¿æ·»åŠ ç‰¹æ®Šæ ‡è¯†
            if [[ "$key" == "zh-ui" || "$key" == "en-ui" ]]; then
                echo "  $((i+1)). $name ($key) [è¯­è¨€]"
            else
                echo "  $((i+1)). $name ($key)"
            fi
        fi
    done

    # æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨æ¨¡æ¿
    if [ ${#templates[@]} -eq 0 ]; then
        echo -e "${RED}âŒ æ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„æ¨¡æ¿æ–‡ä»¶${NC}"
        echo "  è¯·ç¡®ä¿ $CONFIG_DIR/ ç›®å½•ä¸‹æœ‰æ¨¡æ¿æ–‡ä»¶"
        return 1
    fi

    echo ""
    if [ -t 0 ]; then
        # äº¤äº’å¼è¾“å…¥ - éœ€è¦æ˜¾ç¤ºåŸå§‹ç´¢å¼•ç»™ç”¨æˆ·é€‰æ‹©
        if ! read -t 30 -p "è¯·é€‰æ‹©æ¨¡æ¿ (1-${#all_templates[@]}): " -r 2>/dev/null; then
            echo -e "${RED}âŒ è¾“å…¥è¶…æ—¶ï¼Œæ“ä½œå–æ¶ˆ${NC}"
            return 1
        fi
    else
        # ç®¡é“è¾“å…¥
        read -r REPLY
    fi
    echo ""

    # éªŒè¯é€‰æ‹©
    if [[ "$REPLY" =~ ^[0-9]+$ ]] && [ "$REPLY" -ge 1 ] && [ "$REPLY" -le ${#all_templates[@]} ]; then
        local selected_template="${all_templates[$((REPLY-1))]}"
        local template_key="${selected_template%%:*}"
        local template_file="$CONFIG_DIR/$template_key.json"

        # å†æ¬¡æ£€æŸ¥æ¨¡æ¿æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ -f "$template_file" ]; then
            echo "æ­£åœ¨åŸºäºæ¨¡æ¿åˆ›å»ºé…ç½®..."
            cp "$template_file" "$CONFIG_DIR/$config_name.json"

            # æ›´æ–°é…ç½®åç§°å’Œå…ƒæ•°æ®
            if command -v jq >/dev/null 2>&1; then
                jq --arg name "$config_name" '
                    .name = $name |
                    .display_name = ("é…ç½®: " + $name) |
                    .description = ("åŸºäºæ¨¡æ¿åˆ›å»ºçš„é…ç½®")
                ' "$CONFIG_DIR/$config_name.json" > "$CONFIG_DIR/$config_name.json.tmp" && \
                mv "$CONFIG_DIR/$config_name.json.tmp" "$CONFIG_DIR/$config_name.json"
            fi

            echo -e "${GREEN}âœ… é…ç½® '$config_name' å·²åˆ›å»º${NC}"
            echo "  è¯·ç¼–è¾‘é…ç½®æ–‡ä»¶ä»¥è®¾ç½®æ‚¨çš„APIå¯†é’¥å’Œå…¶ä»–å‚æ•°"
            echo "  é…ç½®æ–‡ä»¶ä½ç½®: $CONFIG_DIR/$config_name.json"
        else
            echo -e "${RED}âŒ æ¨¡æ¿æ–‡ä»¶ '$template_key.json' ä¸å­˜åœ¨${NC}"
            echo "  å¯ç”¨æ¨¡æ¿æ–‡ä»¶ï¼š"
            ls -la "$CONFIG_DIR"/*.json 2>/dev/null | grep -o '[^/]*\.json$' | sed 's/^/    /' || echo "    æ— æ¨¡æ¿æ–‡ä»¶"
            return 1
        fi
    else
        echo -e "${RED}âŒ æ— æ•ˆé€‰æ‹©ï¼Œè¯·è¾“å…¥ 1-${#all_templates[@]} ä¹‹é—´çš„æ•°å­—${NC}"
        return 1
    fi
}

# åŸºäºå½“å‰é…ç½®åˆ›å»º
create_from_current() {
    local config_name="$1"

    if [ ! -f "$CLAUDE_CONFIG" ]; then
        echo -e "${RED}âŒ å½“å‰Claudeé…ç½®æ–‡ä»¶ä¸å­˜åœ¨${NC}"
        echo "è¯·å…ˆä½¿ç”¨Claude CLIè¿›è¡Œä¸€æ¬¡è¿æ¥ä»¥åˆ›å»ºé…ç½®æ–‡ä»¶"
        return 1
    fi

    echo "æ­£åœ¨åŸºäºå½“å‰é…ç½®åˆ›å»ºæ–°é…ç½®..."
    cp "$CLAUDE_CONFIG" "$CONFIG_DIR/$config_name.json"

    # æ›´æ–°é…ç½®åç§°å’Œå…ƒæ•°æ®
    if command -v jq >/dev/null 2>&1; then
        jq --arg name "$config_name" '
            .name = $name |
            .display_name = ("é…ç½®: " + $name) |
            .description = ("åŸºäºå½“å‰Claudeé…ç½®ä¿å­˜")
        ' "$CONFIG_DIR/$config_name.json" > "$CONFIG_DIR/$config_name.json.tmp" && \
        mv "$CONFIG_DIR/$config_name.json.tmp" "$CONFIG_DIR/$config_name.json"
    fi

    echo -e "${GREEN}âœ… é…ç½® '$config_name' å·²ä¿å­˜${NC}"
    echo "  é…ç½®æ–‡ä»¶ä½ç½®: $CONFIG_DIR/$config_name.json"
}

# å®Œå…¨è‡ªå®šä¹‰é…ç½®
create_custom() {
    local config_name="$1"

    echo ""
    echo -e "${BLUE}ğŸ› ï¸  è‡ªå®šä¹‰é…ç½®åˆ›å»º${NC}"
    echo "=================="

    # æ”¶é›†åŸºæœ¬ä¿¡æ¯
    local display_name provider description
    if ! read -t 30 -p "æ˜¾ç¤ºåç§°: " display_name 2>/dev/null; then
        echo -e "${RED}âŒ è¾“å…¥è¶…æ—¶ï¼Œæ“ä½œå–æ¶ˆ${NC}"
        return 1
    fi
    if ! read -t 30 -p "æä¾›å•†: " provider 2>/dev/null; then
        echo -e "${RED}âŒ è¾“å…¥è¶…æ—¶ï¼Œæ“ä½œå–æ¶ˆ${NC}"
        return 1
    fi
    if ! read -t 30 -p "æè¿°: " description 2>/dev/null; then
        echo -e "${RED}âŒ è¾“å…¥è¶…æ—¶ï¼Œæ“ä½œå–æ¶ˆ${NC}"
        return 1
    fi

    # æ”¶é›†APIé…ç½®
    echo ""
    echo "APIé…ç½®:"
    local auth_token base_url model timeout
    if ! read -t 30 -p "APIå¯†é’¥ (ANTHROPIC_AUTH_TOKEN): " auth_token 2>/dev/null; then
        echo -e "${RED}âŒ è¾“å…¥è¶…æ—¶ï¼Œæ“ä½œå–æ¶ˆ${NC}"
        return 1
    fi
    if ! read -t 30 -p "APIç«¯ç‚¹ (ANTHROPIC_BASE_URL): " base_url 2>/dev/null; then
        echo -e "${RED}âŒ è¾“å…¥è¶…æ—¶ï¼Œæ“ä½œå–æ¶ˆ${NC}"
        return 1
    fi
    if ! read -t 30 -p "é»˜è®¤æ¨¡å‹ (ANTHROPIC_DEFAULT_SONNET_MODEL): " model 2>/dev/null; then
        echo -e "${RED}âŒ è¾“å…¥è¶…æ—¶ï¼Œæ“ä½œå–æ¶ˆ${NC}"
        return 1
    fi
    if ! read -t 30 -p "è¶…æ—¶æ—¶é—´ (API_TIMEOUT_MS, é»˜è®¤3000000): " timeout 2>/dev/null; then
        echo -e "${RED}âŒ è¾“å…¥è¶…æ—¶ï¼Œæ“ä½œå–æ¶ˆ${NC}"
        return 1
    fi
    timeout=${timeout:-3000000}

    # åˆ›å»ºé…ç½®æ–‡ä»¶
    cat > "$CONFIG_DIR/$config_name.json" << EOF
{
  "name": "$config_name",
  "display_name": "$display_name",
  "provider": "$provider",
  "description": "$description",
  "env": {
    "ANTHROPIC_AUTH_TOKEN": "$auth_token",
    "ANTHROPIC_BASE_URL": "$base_url",
    "API_TIMEOUT_MS": "$timeout",
    "ANTHROPIC_DEFAULT_OPUS_MODEL": "$model",
    "ANTHROPIC_DEFAULT_SONNET_MODEL": "$model",
    "ANTHROPIC_DEFAULT_HAIKU_MODEL": "$model"
  },
  "models": {
    "$model": "é»˜è®¤æ¨¡å‹"
  },
  "default_model": "$model",
  "metadata": {
    "created_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
    "updated_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
    "version": "1.0",
    "note": "ç”¨æˆ·è‡ªå®šä¹‰é…ç½®"
  }
}
EOF

    echo -e "${GREEN}âœ… è‡ªå®šä¹‰é…ç½® '$config_name' å·²åˆ›å»º${NC}"
    echo "  é…ç½®æ–‡ä»¶ä½ç½®: $CONFIG_DIR/$config_name.json"
}

# äº¤äº’å¼èœå•
interactive_menu() {
    while true; do
        clear
        echo -e "${BLUE}Claude API å¿«é€Ÿåˆ‡æ¢å·¥å…·${NC}"
        echo "========================"
        echo ""

        show_status
        echo ""

        echo "å¯ç”¨æ“ä½œ:"
        echo "  1. åˆ‡æ¢é…ç½®"
        echo "  2. ä¿å­˜å½“å‰é…ç½®"
        echo "  3. åˆ—å‡ºæ‰€æœ‰é…ç½®"
        echo "  4. åˆ é™¤é…ç½®"
        echo "  5. å¤‡ä»½å½“å‰é…ç½®"
        echo "  6. è¯­è¨€åˆ‡æ¢"
        echo "  7. é€€å‡º"
        echo ""

        read -p "è¯·é€‰æ‹©æ“ä½œ (1-7): " -n 1 -r
        echo ""

        case $REPLY in
            1)
                echo ""
                echo "è¯·è¾“å…¥é…ç½®åç§°æˆ–ç¼–å·:"
                read -p "> " config_name
                switch_config "$config_name"
                read -p "æŒ‰å›è½¦ç»§ç»­..."
                ;;
            2)
                echo ""
                echo "è¯·è¾“å…¥æ–°é…ç½®åç§°:"
                read -p "> " config_name
                save_config "$config_name"
                read -p "æŒ‰å›è½¦ç»§ç»­..."
                ;;
            3)
                list_configs
                read -p "æŒ‰å›è½¦ç»§ç»­..."
                ;;
            4)
                echo ""
                echo "è¯·è¾“å…¥è¦åˆ é™¤çš„é…ç½®åç§°:"
                read -p "> " config_name
                delete_config "$config_name"
                read -p "æŒ‰å›è½¦ç»§ç»­..."
                ;;
            5)
                backup_config
                read -p "æŒ‰å›è½¦ç»§ç»­..."
                ;;
            6)
                echo ""
                echo "è¯­è¨€åˆ‡æ¢é€‰é¡¹:"
                echo "  1. ä¸­æ–‡ç•Œé¢ (zh-ui)"
                echo "  2. è‹±æ–‡ç•Œé¢ (en-ui)"
                echo "  3. åˆ—å‡ºè¯­è¨€é…ç½®"
                echo "  4. è¿”å›ä¸»èœå•"
                echo ""
                read -p "è¯·é€‰æ‹©è¯­è¨€é€‰é¡¹ (1-4): " -n 1 -r
                echo ""
                case $REPLY in
                    1)
                        switch_config "zh-ui"
                        read -p "æŒ‰å›è½¦ç»§ç»­..."
                        ;;
                    2)
                        switch_config "en-ui"
                        read -p "æŒ‰å›è½¦ç»§ç»­..."
                        ;;
                    3)
                        echo ""
                        echo -e "${BLUE}å¯ç”¨çš„è¯­è¨€é…ç½®:${NC}"
                        echo "===================="
                        for config in "$CONFIG_DIR"/zh-ui.json "$CONFIG_DIR"/en-ui.json; do
                            if [ -f "$config" ]; then
                                local name=$(basename "$config" .json)
                                if command -v jq >/dev/null 2>&1; then
                                    local display_name=$(jq -r '.display_name // "æœªçŸ¥"' "$config")
                                    local description=$(jq -r '.description // "æ— æè¿°"' "$config")
                                    echo -e "  ${GREEN}$name${NC}"
                                    echo "    $display_name"
                                    echo "    $description"
                                    echo ""
                                fi
                            fi
                        done
                        read -p "æŒ‰å›è½¦ç»§ç»­..."
                        ;;
                    4)
                        ;;
                    *)
                        echo -e "${RED}æ— æ•ˆé€‰æ‹©${NC}"
                        read -p "æŒ‰å›è½¦ç»§ç»­..."
                        ;;
                esac
                ;;
            7)
                echo "é€€å‡º"
                break
                ;;
            *)
                echo -e "${RED}æ— æ•ˆé€‰æ‹©${NC}"
                read -p "æŒ‰å›è½¦ç»§ç»­..."
                ;;
        esac
    done
}

# ä¸»ç¨‹åº
# é¢„å¤„ç†å‘½ä»¤è¡Œå‚æ•°ï¼ˆå¤„ç†--langå‚æ•°ï¼‰
preprocess_args() {
    local args=("$@")
    local filtered_args=()
    local i=0

    while [ $i -lt ${#args[@]} ]; do
        local arg="${args[$i]}"
        case "$arg" in
            --lang=*)
                # è¯­è¨€å‚æ•°åœ¨init_i18nä¸­å¤„ç†ï¼Œè·³è¿‡
                ;;
            -l)
                # è·³è¿‡è¯­è¨€å‚æ•°å’Œä¸‹ä¸€ä¸ªå‚æ•°
                ((i++))
                ;;
            *)
                filtered_args+=("$arg")
                ;;
        esac
        ((i++))
    done

    # è®¾ç½®å¤„ç†åçš„å‚æ•°æ•°ç»„
    set -- "${filtered_args[@]}"
}

main() {
    # ä¿å­˜åŸå§‹å‚æ•°ç”¨äºi18nåˆå§‹åŒ–
    local original_args=("$@")

    # é¢„å¤„ç†å‚æ•°
    preprocess_args "$@"

    # Initialize i18n system with original arguments
    init_i18n "${original_args[@]}"

    ensure_dirs
    check_config_file

    case "${1:-}" in
        "list"|"ls"|"l")
            list_configs
            ;;
        "status"|"st"|"s")
            show_status
            ;;
        "save")
            save_config "$2"
            ;;
        "delete")
            delete_config "$2"
            ;;
        "create")
            create_config_interactive
            ;;
        "backup")
            backup_config
            ;;
        "zh-ui"|"chinese"|"ä¸­æ–‡")
            switch_language_to "zh-CN"
            ;;
        "en-ui"|"english"|"è‹±æ–‡")
            switch_language_to "en-US"
            ;;
        "help"|"-h"|"--help")
            show_help
            ;;
        "")
            interactive_menu
            ;;
        *)
            switch_config "$1"
            ;;
    esac
}

# è¿è¡Œä¸»ç¨‹åº
main "$@"